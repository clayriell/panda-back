generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}


//ENTITIES ====================================================================================================================================

model Agency {
  id                            Int @id @default(autoincrement())
  name                          String
  address                       String?
  picName                       String?
  picNumber                     String?
  email                         String?
  
  pilotageService               PilotageService[]
  }

model Company {
  id                            Int              @id @default(autoincrement())
  name                          String
  users                         User[]
  services                      PilotageService[]
  tugs                          AssistTug[]
}

model Terminal {
  id                            Int     @id @default(autoincrement())
  code                          String  @unique
  name                          String
  area                          Area    @default(TANJUNG_UNCANG)

  startActivities ActivityDetail[] @relation("StartTerminal")
  endActivities   ActivityDetail[] @relation("EndTerminal")

}

model AssistTug {
  id                            Int       @id @default(autoincrement())
  shipName                      String
  masterId                      Int?      @unique
  horsePower                    Int
  companyId                     Int?
  company                       Company?  @relation(fields: [companyId], references: [id])
  tugMaster                     User?  @relation(fields: [masterId], references: [id])
  tugDetails                    TugServiceDetail[]
  tugCurrentStatus              TugCurrentStatus?  
}

model User {
  id                            Int              @id @default(autoincrement())
  username                      String?          @unique
  name                          String
  email                         String           @unique
  password                      String           @db.VarChar(255)
  role                          Role             @default(ADMIN)
  picture                       String?
  companyId                     Int?
  isActive                      Boolean          @default(false)
  company                       Company?         @relation(fields: [companyId], references: [id])
  assistTug                     AssistTug?

  // relation 
  submittedServices             PilotageService[] @relation("PilotageServiceSubmittedBy")
  createdServices               PilotageService[] @relation("PilotageServiceCreatedBy")
  submittedTugServices          TugService[] @relation("TugServiceSubmittedBy")
  createdTugServices            TugService[] @relation("TugServiceCreatedBy")
  pilotActivities               ActivityDetail[] @relation("PilotActivities")
  signatures                    DocSignature[]
  pilotCurrentStatus            PilotCurrentStatus?
  userLogs                      ServiceLog[]
}

model ServiceLog {
  id                            Int      @id @default(autoincrement())
  serviceId                     Int?
  serviceType                   ServiceTypeLogs
  userId                        Int?
  action                        String
  createdAt                     DateTime @default(now())  
  user                          User?            @relation(fields: [userId], references: [id])

  @@index([serviceType, serviceId])
}


//SERVICES ====================================================================================================================================

model PilotageService {
  id                            Int           @id @default(autoincrement())
  docNumber                     String?       @unique
  idJasa                        Int?
  agencyId                      Int          
  agency                        Agency        @relation(fields:[agencyId], references:[id])
  companyId                     Int?
  company                       Company?      @relation(fields: [companyId], references: [id])
  description                   String?
  note                          String?
  status                        ServiceStatus @default(REQUESTED)     
  submitTime                    DateTime?
  submittedBy                   Int?
  submittedUser                 User?         @relation("PilotageServiceSubmittedBy", fields: [submittedBy], references: [id])
  createdBy                     Int?
  creator                       User?         @relation("PilotageServiceCreatedBy", fields: [createdBy], references: [id])
  sianatures                    DocSignature[]

  shipDetails                   ShipDetail[]
  tugServices                   TugService[]
  pilotCurrentStatus            PilotCurrentStatus?
  tugCurrentStatuses            TugCurrentStatus[]
  activityDetails               ActivityDetail[]
}

model ActivityDetail{
  id                            Int           @id @default(autoincrement())
  pilotageServiceId             Int
  pilotageService               PilotageService  @relation(fields: [pilotageServiceId], references: [id])
  pilotId                       Int?
  pilot                         User? @relation("PilotActivities", fields: [pilotId], references: [id])
  terminalStartId               Int?
  terminalEndId                 Int?
  terminalStart                 Terminal?     @relation("StartTerminal", fields: [terminalStartId], references: [id])
  terminalEnd                   Terminal?     @relation("EndTerminal", fields: [terminalEndId], references: [id])
  startTime                     DateTime
  endTime                       DateTime?
  activity                      PilotActivity
  sequence                      Int

   @@unique([pilotageServiceId, sequence])
}

model ShipDetail {
  id                            Int              @id @default(autoincrement())
  pilotageServiceId             Int
  pilotageService               PilotageService  @relation(fields: [pilotageServiceId], references: [id])
  name                          String
  master                        String?
  grt                           Int?
  loa                           Decimal?       @db.Decimal(6, 2) 
  flag                          String?
  lastPort                      String?        @db.VarChar(100)
  lastPortCountry               String?        @db.VarChar(60)
  nextPort                      String?        @db.VarChar(100)
  nextPortCountry               String?        @db.VarChar(60)
  callSign                      String?        @db.VarChar(15)
}

model TugService {
  id                            Int              @id @default(autoincrement())
  pilotageServiceId             Int
  pilotageService               PilotageService  @relation(fields: [pilotageServiceId], references: [id])
  idJasa                        Int?
  status                        ServiceStatus    @default(REQUESTED)
  submitTime                    DateTime?
  submittedBy                   Int?
  submittedUser                 User?         @relation("TugServiceSubmittedBy", fields: [submittedBy], references: [id])
  createdBy                     Int?
  creator                       User?         @relation("TugServiceCreatedBy", fields: [createdBy], references: [id])
  description                   String

  tugDetails                    TugServiceDetail[]
}

model TugServiceDetail {
  id                            Int        @id @default(autoincrement())
  tugServiceId                  Int
  tugService                    TugService @relation(fields: [tugServiceId], references: [id])
  assistTugId                   Int
  assistTug                     AssistTug  @relation(fields: [assistTugId], references: [id])
  connectTime                   DateTime?
  disconnectTime                DateTime?
  mobTime                       DateTime?
  demobTime                     DateTime?
  status                        TugStatus @default(WAITING)
  activity                      AssistActivity @default(ASSIST_BERTHING)
  sequence                      Int
  @@unique([tugServiceId, assistTugId, sequence])
}


// BILLINGS  ====================================================================================================================================

model Billing {
  id                            Int @id @default(autoincrement())
  serviceId                     Int
  serviceType                   BillingServiceType
  idJasa                        Int
  amount                        Decimal @db.Decimal(12,2)
  paidDate                      DateTime?

  @@index([serviceType, serviceId])
  @@index([idJasa])
}

// ETC  ====================================================================================================================================

model DocSignature {
  id                            Int       @id @default(autoincrement())
  type                          SignType  
  userId                        Int? 
  pilotageServiceId             Int
  signedAt                      DateTime  @default(now())
  token                         String?   
  signatureImage                String?  @db.LongText
  sequence                      Int?
  
  user    User?                  @relation(fields: [userId], references: [id])
  service PilotageService        @relation(fields: [pilotageServiceId], references: [id])
}

model DocumentCounter {
  id                            Int      @id @default(autoincrement())
  companyCode                   String
  year                          Int
  month                         Int
  counter                       Int          @default(0)

  @@unique([companyCode,year,month])
}

model PilotCurrentStatus {
  userId                        Int      @id
  pilotageServiceId             Int?     @unique
  status                        CurrentPilotStatus
  startTime                     DateTime?
  updatedAt                     DateTime @updatedAt

  user                          User @relation(fields: [userId], references: [id])
  pilotageService               PilotageService? @relation(fields: [pilotageServiceId], references: [id])
}

model TugCurrentStatus {
  assistTugId                   Int      @id
  pilotageServiceId             Int?     @unique
  status                        CurrentTugStatus
  startTime                     DateTime?
  updatedAt                     DateTime @updatedAt

  assistTug                     AssistTug @relation(fields: [assistTugId], references: [id])
  pilotageService               PilotageService? @relation(fields: [pilotageServiceId], references: [id])
}


// ENUMS ====================================================================================================================================
enum Area {
  TANJUNG_UNCANG
  BATU_AMPAR
  KABIL
  REMPANG_GALANG
  LAUT
}

enum ServiceStatus {
  REQUESTED
  APPROVED
  IN_PROCESS
  COMPLETED
  SUBMITTED
  REJECTED
  PAID
  CHECK
  CANCELED
}

enum TugStatus {
  WAITING
  ON_MOB
  ON_WORK
  ON_DEMOB
  COMPLETED
}

enum Role {
  SYS_ADMIN
  ADMIN
  PILOT
  TUG_MASTER
  MANAGER
}

enum PilotActivity {
  PILOT_IN
  PILOT_OUT
  PILOT_SHIFTING
  PILOT_SEATRIAL
}

enum AssistActivity {
  ASSIST_BERTHING
  ASSIST_UNBERTHING
}

enum SignType{
  MANAGER
  PILOT
  TUG_MASTER
  MASTER
}

enum CurrentPilotStatus {
  STAND_BY
  WORKING
}

enum CurrentTugStatus {
  STAND_BY
  ON_MOB
  WORKING
  ON_DEMOB
}

enum ServiceTypeLogs {
  PILOTAGE
  TUG
  SYS_PILOTAGE
  SYS_TUGS
  OTHER
}

enum BillingServiceType {
  PILOTAGE
  TUG
}