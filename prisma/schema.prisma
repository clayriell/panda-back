generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Agency {
  id        Int @id @default(autoincrement())
  name      String
  address   String?
  picName   String?
  picNumber String?
  email     String?
  
  pilotageService PilotageService[]
  }

model AssistTug {
  id        Int       @id @default(autoincrement())
  shipName  String
  masterId  Int?      @unique
  horsePower Int
  companyId Int?
  company   Company?  @relation(fields: [companyId], references: [id])
  tugMaster  User?  @relation(fields: [masterId], references: [id])
  tugDetails TugServiceDetail[]
  
}

model Company {
  id       Int              @id @default(autoincrement())
  name     String
  users    User[]
  services PilotageService[]
  tugs     AssistTug[]
}

model PilotageService {
  id             Int           @id @default(autoincrement())
  docNumber      String? @unique
  idJasa         Int?        // data eksternal
  agencyId       Int          
  companyId      Int?
  company        Company?      @relation(fields: [companyId], references: [id])
  activity       Activity @default(BERTHING)
  terminalStartId Int?
  terminalEndId   Int?
  lastPort       String?
  nextPort       String?
  pilotId        Int?
  startDate      DateTime @db.Date @default(dbgenerated("CURRENT_DATE"))
  startTime      DateTime @db.Time  @default(dbgenerated("CURRENT_TIME"))
  endDate        DateTime? @db.Date
  endTime        DateTime? @db.Time
  note           String?
  status         ServiceStatus @default(REQUESTED)
  amount         Decimal       @db.Decimal(10,2)
  rate           Int?           
  submitTime     DateTime?
  submittedBy    Int?
  submittedUser  User?         @relation("PilotageServiceSubmittedBy", fields: [submittedBy], references: [id])
  createdBy      Int?
  creator        User?         @relation("PilotageServiceCreatedBy", fields: [createdBy], references: [id])

  shipDetails    ShipDetail[]
  tugServices    TugService[]
  terminalStart  Terminal?    @relation("StartTerminal", fields: [terminalStartId], references: [id])
  terminalEnd    Terminal?    @relation("EndTerminal", fields: [terminalEndId], references: [id])
  agency         Agency @relation(fields:[agencyId], references:[id])
  pilot          User?   @relation(fields: [pilotId], references: [id])
  signatures     DocSignature[]
}

model ShipDetail {
  id                Int              @id @default(autoincrement())
  pilotageServiceId Int
  pilotageService   PilotageService  @relation(fields: [pilotageServiceId], references: [id])
  shipName          String
  master            String
  grt               Int?
  loa               Decimal? @db.Decimal(6, 2) 
  flag              String?
}

model Terminal {
  id     Int     @id @default(autoincrement())
  code   String  @unique
  name   String
  area   Area    @default(TANJUNG_UNCANG)

  pilotageServicesStart PilotageService[] @relation("StartTerminal")
  pilotageServicesEnd   PilotageService[] @relation("EndTerminal")
}

model TugService {
  id                Int              @id @default(autoincrement())
  pilotageServiceId Int
  pilotageService   PilotageService  @relation(fields: [pilotageServiceId], references: [id])
  idJasa            Int?           // eksternal
  status            ServiceStatus    @default(APPROVED)
  amount            Decimal          @db.Decimal(10,2)
  submitTime     DateTime?
  submittedBy    Int?
  submittedUser  User?         @relation("TugServiceSubmittedBy", fields: [submittedBy], references: [id])
  createdBy      Int?
  creator        User?         @relation("TugServiceCreatedBy", fields: [createdBy], references: [id])

  tugDetails        TugServiceDetail[]
}

model TugServiceDetail {
  id          Int        @id @default(autoincrement())
  tugServiceId Int
  tugService   TugService @relation(fields: [tugServiceId], references: [id])
  assistTugId Int
  assistTug   AssistTug  @relation(fields: [assistTugId], references: [id])
  connectTime DateTime?
  disconnectTime DateTime?
  mobTime DateTime?
  demobTime DateTime?
  status        TugStatus @default(WAITING)
  activity          AssistActivity @default(ASSIST_BERTHING)
  @@unique([tugServiceId, assistTugId])
}

model User {
  id        Int              @id @default(autoincrement())
  username  String?           @unique
  name      String
  email     String           @unique
  password  String  @db.VarChar(255)
  role      Role             @default(ADMIN)
  picture   String?
  companyId Int?
  isActive  Boolean          @default(false)
  company   Company?         @relation(fields: [companyId], references: [id])
  assistTug AssistTug?
  // relation ke pilotageService (submitter & creator)
  submittedServices PilotageService[] @relation("PilotageServiceSubmittedBy")
  createdServices   PilotageService[] @relation("PilotageServiceCreatedBy")
  submittedTugServices TugService[] @relation("TugServiceSubmittedBy")
  createdTugServices   TugService[] @relation("TugServiceCreatedBy")
  pilotageServices PilotageService[]
  signatures     DocSignature[]
}

model ServiceLog {
  id          Int      @id @default(autoincrement())
  serviceId   Int?
  serviceType String
  userId      Int
  action      String
  createdAt   DateTime @default(now())

  @@index([serviceType, serviceId])
}

model DocSignature {
  id                 Int      @id @default(autoincrement())
  userId             Int
  pilotageServiceId  Int  
  signedAt           DateTime @default(now())
  token              String
  user               User             @relation(fields: [userId], references: [id])
  service            PilotageService  @relation(fields: [pilotageServiceId], references: [id])
  
}


enum Area {
  TANJUNG_UNCANG
  BATU_AMPAR
  KABIL
  REMPANG_GALANG
  LAUT
}

enum ServiceStatus {
  REQUESTED
  APPROVED
  IN_PROCESS
  COMPLETED
  SUBMITTED
  REJECTED
  PAID
  CHECK
  CANCELED
}
enum TugStatus {
  WAITING
  ON_MOB
  ON_WORK
  ON_DEMOB
  COMPLETED
}

enum Role {
  SYS_ADMIN
  ADMIN
  PILOT
  TUG_MASTER
}
enum Activity {
  BERTHING
  UNBERTHING
  SEA_TRIAL
  SHIFTING
}

enum AssistActivity {
  ASSIST_BERTHING
  ASSIST_UNBERTHING
  SEA_TRIAL
  ASSIST_SHIFTING
}
